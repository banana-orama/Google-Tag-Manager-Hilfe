---
last_mapped: 2026-02-12T21:32:55Z
total_files: 160
total_tokens: 435337
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-02-12T21:32:55Z

## System Overview

This is a collection of GTM (Google Tag Manager) tools and utilities comprising three main projects:

```mermaid
graph TB
    subgraph "Main Projects"
        GTM_OPT[GTM Optimizer<br/>Web-based analysis tool]
        GTM_MCP[GTM MCP Server<br/>API integration layer]
        CART[Cartographer<br/>Codebase mapping plugin]
    end

    subgraph "Supporting"
        CLAUDE[.claude/skills<br/>Marketing skills]
        DOCS[Documentation files]
    end

    GTM_OPT -->|Analyzes| GTM_JSON[GTM Container JSON]
    GTM_OPT -->|Generates| SSG[Server-Side Container]
    GTM_MCP -->|Reads/Writes| GTM_API[GTM API v2]
    GTM_MCP -->|Validates| REGISTRY[Template Registry]
    CLAUDE -->|Enhances| CLAUDE_AI[Claude AI capabilities]
```

## Directory Structure

```
Google Tag Manager Hilfe/
├── gtm-mcp-server/          # MCP Server for GTM API (TypeScript)
│   ├── src/                 # Alternate source location
│   ├── auth/                # OAuth2 authentication
│   ├── config/              # Template registry (JSON)
│   ├── scripts/             # Selftest, seed scripts
│   ├── tools/               # GTM API tool implementations
│   ├── types/               # TypeScript type definitions
│   └── utils/               # Rate limiting, validation, helpers
│
├── gtm-optimizer/           # Web-based GTM analysis tool (JavaScript)
│   ├── js/                  # Core application logic
│   ├── css/                 # Styling
│   ├── index.html           # Main UI
│   └── data/                # Sample data
│
├── cartographer/            # Claude Code plugin for codebase mapping
│   └── plugins/cartographer/
│       └── skills/cartographer/
│           └── scripts/     # Scanner script
│
├── .claude/skills/          # Marketing and copywriting skills
│   ├── ab-test-setup/
│   ├── analytics-tracking/
│   ├── copywriting/
│   ├── seo-audit/
│   └── [20+ more skills]
│
├── src/                     # Mirror of gtm-mcp-server/src
├── CONTINUITY.md            # Project ledger/goals
├── PLAN-GTM-MCP-SERVER.md   # MCP server implementation plan
└── docs/                    # Generated documentation
    └── CODEBASE_MAP.md      # This file
```

## Module Guide

### gtm-mcp-server

**Purpose**: Model Context Protocol server that provides AI assistants direct access to Google Tag Manager API v2

**Entry point**: `gtm-mcp-server/index.ts`

**Key files**:

| File | Purpose | Tokens |
|------|---------|--------|
| `index.ts` | Main server entry point, tool registration, request routing | 24,173 |
| `config/template-registry.json` | Template gallery registry with verified entries | 28,925 |
| `utils/template-registry.ts` | Template type resolution, validation, preflight checks | 3,745 |
| `utils/container-validator.ts` | Container type detection, trigger/variable validation | 4,425 |
| `utils/llm-helpers.ts` | Trigger templates, variable parameters, validation helpers | 4,338 |
| `utils/error-handler.ts` | Detailed error handling with suggestions and examples | 3,256 |
| `utils/tag-helpers.ts` | Tag type info, parameter validation | 2,966 |
| `utils/workflow-guides.ts` | Workflow guides for common GTM tasks | 3,977 |
| `scripts/selftest.ts` | MCP stdio end-to-end testing infrastructure | 14,281 |
| `scripts/seed-template-registry.ts` | Template registry seeding from gallery | 3,509 |
| `auth/oauth.ts` | OAuth2 authentication flow with Google | 1,977 |
| `utils/rate-limiter.ts` | API rate limiting (0.25 QPS, 10k/day) | 1,664 |

**Exports**: MCP tools for GTM operations (accounts, containers, tags, triggers, variables, etc.)

**Dependencies**:
- `@modelcontextprotocol/sdk` - MCP server framework
- `googleapis` - Google API client library
- `open` - Browser launcher for OAuth

**Dependents**: Claude Desktop/Code when configured as MCP server

**Architecture**:
```
Client (Claude) → MCP Protocol → GTM MCP Server → Rate Limiter → GTM API
                                      ↓
                              Template Registry
                                      ↓
                              OAuth2 Token Store
```

**Key Features**:
- Full GTM API v2 coverage (web + server containers)
- Template registry with gallery import verification
- Rate limiting enforcement (10k requests/day, 0.25 QPS)
- Token-efficient responses (compressed listings, detailed views on demand)
- Safe operations (confirmations for destructive actions)
- Comprehensive selftest infrastructure
- Docker support for isolation

---

### gtm-optimizer

**Purpose**: Web-based tool for analyzing, cleaning, and optimizing GTM containers with server-side GTM migration support

**Entry point**: `gtm-optimizer/index.html`

**Key files**:

| File | Purpose | Tokens |
|------|---------|--------|
| `index.html` | Main application UI | 5,949 |
| `js/optimizer.js` | Core optimization orchestration | 2,944 |
| `js/rules.js` | Analysis rules engine | 10,833 |
| `js/deduplicator.js` | Duplicate detection/removal | 2,588 |
| `js/ssg-prep.js` | Server-side migration prep | 5,152 |
| `js/ssg-generator.js` | Server-side container generation | 10,670 |
| `js/gtm-parser.js` | GTM JSON parsing/validation | 3,940 |
| `js/ui.js` | UI event handlers | 11,323 |
| `css/style.css` | Application styling | 8,622 |

**Exports**: Single-page web application (HTML + CSS + JS)

**Dependencies**:
- Browser APIs (File API, Clipboard API, Fetch)
- No external libraries (pure vanilla JS)

**Dependents**: End users via web browser (local execution)

**Workflow**:
```
Upload GTM JSON → Parse → Rules Engine Analysis → Display Issues
                                                      ↓
                                               User Selects Fixes
                                                      ↓
                                  Apply Optimizations → Export Cleaned JSON
                                                      ↓
                                  Server-Side Generator → SSG Container Bundle
```

**Key Features**:
- Unused element detection (tags, triggers, variables)
- Duplicate element identification and removal
- Best practices validation (naming, structure, security)
- Server-side GTM migration preparation
- Vendor selection for SSG (Google, Facebook, LinkedIn, Microsoft)
- Stape template embedding for SSG vendors
- Audit report and change log export
- Local-only execution (no server needed)

---

### cartographer

**Purpose**: Claude Code plugin that maps and documents codebases using parallel AI subagents

**Entry point**: `cartographer/plugins/cartographer/skills/cartographer/SKILL.md`

**Key files**:

| File | Purpose | Tokens |
|------|---------|--------|
| `README.md` | Installation and usage documentation | 492 |
| `plugins/cartographer/skills/cartographer/SKILL.md` | Skill definition and workflow | 2,150 |
| `plugins/cartographer/skills/cartographer/scripts/scan-codebase.py` | File tree scanner with token counts | 3,357 |

**Exports**: Claude Code skill definition

**Dependencies**:
- `tiktoken` - Token counting library
- Python 3.x

**Dependents**: Claude Code users for codebase understanding

**Architecture**:
```
Claude Code → Load Cartographer Skill → Run Scanner (Python)
                                                ↓
                                      Plan Subagent Assignments
                                                ↓
                                Spawn Sonnet Subagents in Parallel
                                                ↓
                                      Synthesize Reports
                                                ↓
                                  Write CODEBASE_MAP.md
```

**Key Features**:
- Parallel analysis with AI subagents
- Token budget management (150k per subagent)
- Git-based change detection for incremental updates
- Automatic documentation generation

---

### .claude/skills

**Purpose**: Collection of specialized marketing, copywriting, and SEO skills for Claude AI

**Entry point**: Individual SKILL.md files in each subdirectory

**Key skills** (30+ total):

| Skill | Purpose | Tokens |
|-------|---------|--------|
| `copywriting/` | Marketing copy creation | ~1.6k |
| `copy-editing/` | Copy review and improvement | ~3k |
| `email-sequence/` | Email campaign creation | ~2k |
| `page-cro/` | Conversion rate optimization | ~1.3k |
| `seo-audit/` | SEO health checks | ~2k |
| `analytics-tracking/` | Analytics setup guidance | ~1.8k |
| `pricing-strategy/` | Pricing and packaging | ~1.5k |
| `ab-test-setup/` | Experiment design | ~1.7k |

**Exports**: Skill definitions loaded by Claude

**Dependencies**: None (self-contained markdown)

**Dependents**: Claude AI when invoked with matching keywords

## Data Flow

### GTM MCP Server Flow

```mermaid
sequenceDiagram
    participant User
    participant Claude
    participant MCP
    participant Registry
    participant GTM

    User->>Claude: "List my GTM containers"
    Claude->>MCP: gtm_list_accounts
    MCP->>MCP: Check OAuth tokens
    MCP->>MCP: Rate limiter: queue request
    MCP->>GTM: GET /accounts
    GTM-->>MCP: Account list
    MCP-->>Claude: Compressed account list
    Claude-->>User: "You have 3 accounts..."
    
    User->>Claude: "Create a GA4 tag using stape template"
    Claude->>MCP: gtm_create_tag with templateReference
    MCP->>Registry: Resolve type from registry
    Registry-->>MCP: Type + defaults + validation
    MCP->>MCP: Preflight validation
    MCP->>GTM: POST /tags
    GTM-->>MCP: Created tag
    MCP-->>Claude: Tag created
```

### GTM Optimizer Flow

```mermaid
sequenceDiagram
    participant User
    participant UI
    participant Parser
    participant Rules
    participant SSG

    User->>UI: Upload GTM JSON
    UI->>Parser: Parse container
    Parser->>Parser: Validate structure
    Parser->>Parser: Find duplicates
    Parser->>Rules: Run analysis
    Rules-->>UI: Issues, scores, suggestions
    UI-->>User: Display results
    User->>UI: Select fixes + vendors
    UI->>SSG: Generate SSG container
    SSG-->>UI: Server + modified client
    UI-->>User: Download bundle
```

## Conventions

### gtm-mcp-server
- TypeScript with ES modules
- Tool naming: `gtm_<resource>_<action>` (e.g., `gtm_list_tags`)
- Path format: `accounts/{accountId}/containers/{containerId}`
- Async/await for all API calls
- Rate limiting applied to all API operations
- Destructive operations require user confirmation
- Template references validated against registry
- API v2 format for all parameters (arg0/arg1 with type field)

### gtm-optimizer
- Vanilla JavaScript (no framework)
- CSS custom properties for theming
- Class-based architecture (GTMOptimizer, GTMRulesEngine, etc.)
- German UI text
- Local execution only (no server communication)
- File-based I/O for import/export

### cartographer
- Python 3.x for scanner
- Markdown for skill definitions
- Claude Code MCP skill format
- Token budgets: 150k per subagent (Sonnet)

## Gotchas

### gtm-mcp-server
- **OAuth setup required**: Must run `npm run auth` before first use
- **Rate limits**: GTM API allows only 0.25 QPS (1 request per 4 seconds)
- **Authentication**: Tokens stored in `~/.gtm-mcp/` with mode 600
- **Container types**: Web and server containers support different trigger types
- **Path sensitivity**: All API paths are case-sensitive
- **Template registry**: Use `templateReference` for deterministic type resolution
- **Parameter format**: All parameters need `type` field (template, boolean, integer, list, map)
- **Trigger conditions**: Use `parameter` array with `arg0`/`arg1` keys (API v2 format)

### gtm-optimizer
- **Folder naming**: GTM rejects folders starting with "_" (bug fixed - now uses "Einstellungen")
- **File naming**: Download preserves original filename for client container
- **SSG templates**: Large template file excluded from token counting (218k tokens)
- **1:1 mapping**: Server-side tags map 1:1 to client tags (no deduplication)
- **GA4 base tag**: Only created when GA4 tags are selected for migration

### cartographer
- **Scanner dependencies**: Requires `tiktoken` (auto-installed with `uv run`)
- **Token accuracy**: Tiktoken counts may differ from actual Claude tokenization
- **Subagent spawning**: Requires Claude Code's Task tool capability
- **Git requirement**: Change detection works best with git history

## Navigation Guide

### To modify GTM API tool behavior
1. Go to `gtm-mcp-server/tools/`
2. Edit the relevant tool file (e.g., `tags.ts`, `triggers.ts`)
3. Run `npm run build` to recompile
4. Restart Claude Code to load changes

### To add new template types to registry
1. Go to `gtm-mcp-server/config/template-registry.json`
2. Add entry with owner, repository, type, containerContext, entityKind
3. Run `npm run template-registry:seed -- --owner <owner>` to verify
4. Use `scripts/validate-template-registry.ts` to validate

### To add new analysis rules to GTM Optimizer
1. Go to `gtm-optimizer/js/rules.js`
2. Add rule definition to `RULES` array
3. Implement validation logic in `validate()` function
4. Update `ssg-prep.js` if rule affects server-side readiness
5. Test by reloading `index.html` in browser

### To add new GTM entity support to MCP server
1. Create new tool file in `gtm-mcp-server/tools/`
2. Export functions: `list*`, `get*`, `create*`, `delete*`
3. Add tool schema to `TOOLS` array in `index.ts`
4. Add case handler in `CallToolRequestSchema` handler
5. Test with selftest: `npm run selftest`

### To debug MCP server issues
1. Run `gtm-mcp-server/dist/index.js` manually
2. Check `~/.gtm-mcp/` for token files
3. Verify OAuth credentials are valid
4. Check rate limiter status with `gtm_status` tool
5. Run selftest: `npm run selftest -- --mode readonly`

## Technical Specifications

### GTM API v2 Coverage

The MCP server implements 80+ tools covering:

**Core Entities:**
- Accounts, Containers, Workspaces, Environments
- Tags, Triggers, Variables, Folders
- Templates (custom + gallery import)
- Built-in Variables
- Versions (create, publish, export)

**Server-Side GTM:**
- Clients, Transformations, Zones
- Destinations, Gtag Configs

**Operations:**
- Read (list, get)
- Write (create, update, delete)
- Analysis (container summary, best practices)
- Versioning (create, publish, compare)

**Helper Tools:**
- `gtm_validate_trigger_config` - Pre-validate trigger configs
- `gtm_get_trigger_template` - Get example trigger configs
- `gtm_get_tag_parameters` - Get required/optional tag params
- `gtm_get_variable_parameters` - Get variable type params
- `gtm_get_workflow` - Get step-by-step workflow guides
- `gtm_check_best_practices` - Analyze workspace for issues

### Template Registry

**Purpose**: Resolve and validate community template types for deterministic entity creation

**Schema**:
```json
{
  "owner": "stape-io",
  "repository": "facebook-pixel",
  "containerContext": "SERVER",
  "entityKind": "tag",
  "type": "68",
  "status": "verified",
  "requiredParameters": [],
  "optionalParameters": [],
  "defaults": {}
}
```

**Status values**: `verified`, `candidate`, `broken`, `unknown`

### GTM Optimizer Analysis Categories

**Cleanup Issues:**
- Unused tags, triggers, variables
- Duplicate elements
- Invalid references

**Performance Issues:**
- Large tag counts
- Complex trigger conditions
- JavaScript macro overuse

**Structure Issues:**
- Naming conventions
- Folder organization
- Tag sequencing

**Security Issues:**
- PII in variables
- Unsafe JavaScript
- Missing consent management

**SSG Readiness:**
- Client-side tag detection
- Vendor identification
- Migration complexity

### Rate Limiting Details

**GTM API Quotas:**
- 10,000 requests per day per Google Cloud project
- 0.25 QPS (1 request every 4 seconds)
- 25 requests per 100 seconds

**Rate Limiter Implementation:**
- Queue-based with automatic delay
- Daily reset at midnight PST
- Status reporting via `gtm_status`
- Automatic token refresh

## File Statistics

**Total Codebase:**
- Files: 160 (excluding 8 skipped large files)
- Tokens: 435,337
- Lines of code: ~12,000 (estimated)

**By Project:**
- gtm-mcp-server: ~120k tokens (28%)
- gtm-optimizer: ~55k tokens (13%)
- .claude/skills: ~80k tokens (18%)
- cartographer: ~6k tokens (1%)
- Documentation: ~40k tokens (9%)
- Selftest reports: ~80k tokens (18%)

**Skipped Files:**
- `gtm-optimizer/js/ssg-templates.js`: 218,308 tokens (too large)
- `selftest-web-report.json`: 183,412 tokens
- `GTM-TG92FFT5_workspace48.json`: 294,735 tokens
- `GTM-NKS7PLF8_v6.json`: 202,394 tokens
- `Beispiel SErverseitiger Container GTM.json`: 71,629 tokens
- `selftest-server-report.json`: 57,519 tokens

---

*Generated by Cartographer - https://github.com/kingbootoshi/cartographer*
